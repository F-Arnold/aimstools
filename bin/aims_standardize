#!/usr/bin/env python
import os, sys
from AIMS_tools.misc import *
from AIMS_tools.structuretools import structure
import argparse


def parseArguments():
    # Create argument parser
    parser = argparse.ArgumentParser()

    # Positional mandatory arguments
    parser.add_argument("structure", help="Path to structure file.", type=str)

    # Optional arguments
    parser.add_argument(
        "--prec",
        help="Precision to determine equivalent structures",
        type=float,
        default=1e-4,
    )

    parser.add_argument(
        "--enforce2D",
        help="Enforce 2D representation if system appears 2D.",
        type=bool,
        default=True,
    )
    # Parse arguments
    args = parser.parse_args()
    return args


if __name__ == "__main__":
    args = parseArguments()
    struc = structure(args.structure)

    if args.enforce2D and struc.is_2d():
        struc.atoms = struc.enforce_2d()
    else:
        try:
            struc.standardize(symprec=args.prec)
        except:
            logging.info("Spglib standardization did not work, trying ASE standard...")
            rcell, Q = struc.atoms.cell.standard_form()
            struc.atoms.set_cell(rcell)
            struc.atoms.set_positions((Q @ struc.atoms.positions.T).T)
    if args.structure.split(".")[-1] == "xyz":
        struc.atoms.write(args.structure, vec_cell=True)
    else:
        struc.atoms.write(args.structure)
